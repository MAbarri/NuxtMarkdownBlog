import{bI as t,bJ as e,bK as n,bH as r,bj as i,b2 as a}from"../runtime.mjs";import{c as o,o as s,g as l,b as c,d as u,f as d,h as f,i as g,k as p}from"./query-BuxgHUnZ.mjs";import{e as h,g as m}from"./server.mjs";import{u as y}from"./preview-wkaBPEZ5.mjs";import"../routes/renderer.mjs";function createMatch(t={}){const e=function(t,e={}){return{$match:(e,n)=>t(e,n),$eq:(t,e)=>e instanceof RegExp?e.test(t):t===e,$ne:(t,e)=>e instanceof RegExp?!e.test(t):t!==e,$not:(e,n)=>!t(e,n),$and:(e,n)=>(c(n,"$and requires an array as condition"),n.every((n=>t(e,n)))),$or:(e,n)=>(c(n,"$or requires an array as condition"),n.some((n=>t(e,n)))),$in:(e,n)=>u(n).some((n=>Array.isArray(e)?t(e,{$contains:n}):t(e,n))),$contains:(t,e)=>(t=Array.isArray(t)?t:String(t),u(e).every((e=>t.includes(e)))),$icontains:(t,e)=>{if("string"!=typeof e)throw new TypeError("$icontains requires a string, use $contains instead");return t=String(t).toLocaleLowerCase(),u(e).every((e=>t.includes(e.toLocaleLowerCase())))},$containsAny:(t,e)=>(c(e,"$containsAny requires an array as condition"),t=Array.isArray(t)?t:String(t),e.some((e=>t.includes(e)))),$exists:(t,e)=>e?void 0!==t:void 0===t,$type:(t,e)=>typeof t===String(e),$regex:(t,e)=>{if(!(e instanceof RegExp)){const t=String(e).match(/\/(.*)\/([dgimsuy]*)$/);e=(null==t?void 0:t[1])?new RegExp(t[1],t[2]||""):new RegExp(e)}return e.test(String(t||""))},$lt:(t,e)=>t<e,$lte:(t,e)=>t<=e,$gt:(t,e)=>t>e,$gte:(t,e)=>t>=e,...e||{}}}(match,t.operators);function match(t,n){return"object"!=typeof n||n instanceof RegExp?e.$eq(t,n):Object.keys(n||{}).every((r=>{const i=n[r];if(r.startsWith("$")&&e[r]){const n=e[r];return"function"==typeof n&&n(t,i)}return match(l(t,r),i)}))}return match}function createPipelineFetcher(t){const e=createMatch(),n=[(t,n)=>{const r=t.result.filter((t=>u(n.where).every((n=>e(t,n)))));return{...t,result:r,total:r.length}},(t,e)=>u(e.sort).forEach((e=>d(t.result,e))),function(t,n,r){var i;if(n.surround){let a=((t,{query:n,before:r,after:i})=>{const a="string"==typeof n?{_path:n}:n,o=t.findIndex((t=>e(t,a)));r=null!=r?r:1,i=null!=i?i:1;const s=new Array(r+i).fill(null,0);return-1===o?s:s.map(((e,n)=>t[o-r+n+Number(n>=r)]||null))})(1===(null==(i=t.result)?void 0:i.length)?r:t.result,n.surround);a=f(g(n.without))(a),a=f(p(n.only))(a),t.surround=a}return t}],r=[(t,e)=>{if(e.skip)return{...t,result:t.result.slice(e.skip),skip:e.skip}},(t,e)=>{if(e.limit)return{...t,result:t.result.slice(0,e.limit),limit:e.limit}},function(t,e,n){var r,i,o;if(e.dirConfig){const s=(null==(r=t.result[0])?void 0:r._path)||(null==(o=null==(i=e.where)?void 0:i.find((t=>t._path)))?void 0:o._path);if("string"==typeof s){const e=n.find((t=>t._path===a(s,"_dir")));e&&(t.dirConfig={_path:e._path,...g(["_"])(e)})}}return t},(t,e)=>({...t,result:f(g(e.without))(t.result)}),(t,e)=>({...t,result:f(p(e.only))(t.result)})];return async e=>{const i=await t(),a=e.params(),o={result:i,limit:0,skip:0,total:i.length},l=n.reduce(((t,e)=>e(t,a,i)||t),o);if(a.count)return{result:l.result.length};const c=r.reduce(((t,e)=>e(t,a,i)||t),l);return a.first?{...s(["skip","limit","total"])(c),result:c.result[0]}:c}}function createPipelineFetcherLegacy(t){const e=createPipelineFetcher(t);return async t=>{var n;t.params().first&&t.withDirConfig();const r=t.params(),i=await e(t);return r.surround?null==i?void 0:i.surround:((null==i?void 0:i.dirConfig)&&(i.result={_path:null==(n=i.dirConfig)?void 0:n._path,...i.result,_dir:i.dirConfig}),null==i?void 0:i.result)}}const generateTitle=t=>t.split(/[\s-]/g).map(i).join(" ");function createNav(t,e){const{navigation:n}=m().public.content;if(!1===n)return[];const pickNavigationFields=t=>{return{...(r=["title",...n.fields],t=>(t=t||{},r&&r.length?r.filter((e=>void 0!==t[e])).reduce(((e,n)=>Object.assign(e,{[n]:t[n]})),{}):t))(t),...(e=null==t?void 0:t.navigation,"[object Object]"===Object.prototype.toString.call(e)?t.navigation:{})};var e,r};return sortAndClear(t.sort(((t,e)=>t._path.localeCompare(e._path))).reduce(((t,n)=>{var r;const i=n._path.substring(1).split("/"),a=n._id.split(":").slice(1),o=!!(null==(r=a[a.length-1])?void 0:r.match(/([1-9][0-9]*\.)?index.md/g)),getNavItem=t=>({title:t.title,_path:t._path,_file:t._file,children:[],...pickNavigationFields(t),...t._draft?{_draft:!0}:{}}),s=getNavItem(n);if(o){const r=e[s._path];if(void 0!==(null==r?void 0:r.navigation)&&!(null==r?void 0:r.navigation))return t;if("/"!==n._path){const t=getNavItem(n);s.children.push(t)}r&&Object.assign(s,pickNavigationFields(r))}if(1===i.length)return t.push(s),t;return i.slice(0,-1).reduce(((t,r,a)=>{const o="/"+i.slice(0,a+1).join("/"),s=e[o];if(void 0!==(null==s?void 0:s.navigation)&&!s.navigation)return[];let l=t.find((t=>t._path===o));return l||(l={title:generateTitle(r),_path:o,_file:n._file,children:[],...s&&pickNavigationFields(s)},t.push(l)),l.children}),t).push(s),t}),[]))}const v=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});function sortAndClear(t){var e;t.forEach((t=>{t._file=t._file.split(".").slice(0,-1).join(".")}));const n=t.sort(((t,e)=>v.compare(t._file,e._file)));for(const t of n)(null==(e=t.children)?void 0:e.length)?sortAndClear(t.children):delete t.children,delete t._file;return t}const withContentBase=t=>r(t,m().public.content.api.baseURL),_=t(e({driver:n()}),"@content");function createDB(t){async function getItems(){const e=new Set(await t.getKeys("cache:")),n=y().getPreviewToken();if(n){const r=await t.getItem(`${n}$`).then((t=>t||{}));if(Array.isArray(r.ignoreSources)){const t=r.ignoreSources.map((t=>`cache:${t.trim()}:`));for(const n of e)t.some((t=>n.startsWith(t)))&&e.delete(n)}const i=await t.getKeys(`${n}:`),a=await Promise.all(i.map((e=>t.getItem(e))));for(const t of a)e.delete(`cache:${t._id}`),t.__deleted||e.add(`${n}:${t._id}`)}return await Promise.all(Array.from(e).map((e=>t.getItem(e))))}return{storage:t,fetch:createPipelineFetcherLegacy(getItems),query:t=>o(createPipelineFetcherLegacy(getItems),{initialParams:t,legacy:!0})}}let w=null,$=null;async function useContentDatabase(){return $?await $:w||($=async function(){const t=h(),{content:e}=m().public,n=createDB(_),r=await n.storage.getItem("integrity");if(e.integrity!==+(r||0)){const{contents:t,navigation:r}=await $fetch(withContentBase(e.integrity?`cache.${e.integrity}.json`:"cache.json"));await Promise.all(t.map((t=>n.storage.setItem(`cache:${t._id}`,t)))),await n.storage.setItem("navigation",r),await n.storage.setItem("integrity",e.integrity)}return await t.callHook("content:storage",n.storage),n}(),w=await $),w}async function generateNavigation(t){const e=await useContentDatabase();if(!y().getPreviewToken()&&0===Object.keys(t||{}).length)return e.storage.getItem("navigation");return createNav(await e.query(t).where({_partial:!1,navigation:{$ne:!1}}).find(),(await e.query().where({_path:/\/_dir$/i,_partial:!0}).find()).reduce(((t,e)=>{var n;"dir"===(null==(n=e.title)?void 0:n.toLowerCase())&&(e.title=void 0);return t[e._path.split("/").slice(0,-1).join("/")||"/"]={...e,...e.body},t}),{}))}export{_ as contentStorage,createDB,generateNavigation,useContentDatabase};
//# sourceMappingURL=client-db-kc1ht2FJ.mjs.map
